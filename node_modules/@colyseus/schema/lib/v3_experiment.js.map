{"version":3,"file":"v3_experiment.js","sourceRoot":"","sources":["../src/v3_experiment.ts"],"names":[],"mappings":"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","sourcesContent":["import * as util from \"node:util\";\nimport \"./symbol.shim\";\n\nimport {\n    view,\n    type,\n    Schema,\n    ArraySchema,\n    MapSchema,\n    Encoder,\n    Decoder,\n    StateView,\n\n    encode, decode,\n    OPERATION,\n    encodeKeyValueOperation,\n    encodeSchemaOperation,\n    decodeKeyValueOperation,\n    decodeSchemaOperation,\n\n    $changes, $decoder, $deleteByIndex, $encoder, $getByIndex, $track,\n\n    Metadata,\n    ChangeTree,\n    Ref,\n    Reflection,\n\n} from \".\";\n\nimport { getStateCallbacks } from \"./decoder/strategy/StateCallbacks\";\nimport { getRawChangesCallback } from \"./decoder/strategy/RawChanges\";\n\nconst $callback = {\n    $onCreate: Symbol('$onCreate'),\n    $onDelete: Symbol('$onDelete'),\n    $onUpdate: Symbol('$onUpdate'),\n}\n\nfunction logSingleCall(label: string, callback: Function) {\n    const time = Date.now();\n    const res = callback();\n    console.log(`${label}:`, Date.now() - time);\n    return res;\n}\n\nfunction logTime(label: string, callback: Function) {\n    const time = Date.now();\n    for (let i = 0; i < 500000; i++) {\n        callback();\n    }\n    console.log(`${label}:`, Date.now() - time);\n}\n\n\n// // @ts-ignore\n// globalThis.perform = function perform() {\n//     for (let i = 0; i < 500000; i++) {\n//         encoder.encodeAll();\n//     }\n// }\n\n// const timeout = setInterval(() => {}, 1000);\n\n// function decorate({ get, set }, context: ClassAccessorDecoratorContext): ClassAccessorDecoratorResult<any, any> {\n//     const field = context.name.toString();\n//     // const fieldIndex = Metadata.addField(context.metadata, field, type);\n\n//     const parent = Object.getPrototypeOf(context.metadata);\n\n//     let lastIndex = (parent && parent[-1] as number) ?? -1;\n//     lastIndex++;\n\n//     context.metadata[field] = { type: \"number\" };\n\n//     Object.defineProperty(context.metadata, lastIndex, {\n//         value: field,\n//         enumerable: false,\n//         configurable: true,\n//     });\n\n//     Object.defineProperty(context.metadata, -1, {\n//         value: lastIndex,\n//         enumerable: false,\n//         configurable: true\n//     });\n\n//     return {\n//         init(value) { return value; },\n//         get() { return get.call(this); },\n//         set(value: any) { set.call(this, value); },\n//     };\n// }\n\n// class Fruit {\n//     @decorate accessor frutose: number = 1;\n// }\n\n// class Banana extends Fruit {\n//     @decorate accessor potassium: number = 10;\n// }\n\n// class Berry extends Fruit {\n//     @decorate accessor antioxidants: number = 10;\n// }\n\n// class Strawberry extends Berry {\n//     @decorate accessor fiber: number = 10;\n// }\n\n// class Grape extends Berry {\n//     @decorate accessor vitaminc: number = 5;\n// }\n\n// console.log(\"fruit:\", Fruit[Symbol.metadata], Object.keys(Fruit[Symbol.metadata]));\n// console.log(\"banana:\", Banana[Symbol.metadata], Object.keys(Banana[Symbol.metadata]));\n// console.log(\"strawberry:\", Strawberry[Symbol.metadata], Object.keys(Strawberry[Symbol.metadata]));\n// console.log(\"grape:\", Grape[Symbol.metadata], Object.keys(Grape[Symbol.metadata]));\n\n// console.log(\"GRAPE =>\");\n\n// function printFields(metadata) {\n//     let i = 0;\n//     const len = metadata[-1]\n//     console.log({ len });\n//     for (let i = 0; i <= len; i++) {\n//         console.log(\"over len...\", i, metadata[i])\n//     }\n// }\n\n// console.log(\"Grape...\");\n// printFields(Grape[Symbol.metadata]);\n\n// console.log(\"Banana...\");\n// printFields(Banana[Symbol.metadata]);\n\n\n// class Item extends Schema {\n//     @type(\"string\") accessor name: string;\n// }\n\n// class RootState extends Schema {\n//     @type([Item]) accessor items = new ArraySchema<Item>();\n// }\n\n// const s = new RootState();\n// s.items.push(new Item().assign({ name: \"hello\" }));\n\n// const encoder = new Encoder(s);\n// const encoded = encoder.encode();\n\n// const decoder = new Decoder(new RootState());\n// decoder.decode(encoded);\n\nfunction log(message: any) {\n    console.log(util.inspect(message, false, 10, true));\n}\n\n// // No need to extend Schema!\n// class Vec3 {\n//     x: number;\n//     y: number;\n//     z: number;\n//     constructor() {\n//         // Need to initialize property descriptors\n//         Schema.initialize(this);\n//     }\n// }\n// // Define fields to encode/decode\n// Metadata.setFields(Vec3, {\n//     x: \"number\",\n//     y: \"number\",\n//     z: \"number\",\n// });\n// //\n// Vec3[$track] = function (\n//     changeTree: ChangeTree,\n//     index: number,\n//     operation: OPERATION = OPERATION.ADD\n// ) {\n//     changeTree.change(index, operation);\n// };\n// Vec3[$encoder] = encodeSchemaOperation;\n// Vec3[$decoder] = decodeSchemaOperation;\n// // @ts-ignore\n// if (!Vec3.prototype.toJSON) { Vec3.prototype.toJSON = Schema.prototype.toJSON; }\n\n// -------------------------------------------------------------------------------\n\nclass Vec3 extends Schema {\n    @type(\"number\") x: number;\n    @type(\"number\") y: number;\n    @type(\"number\") z: number;\n}\n// Vec3[$track] = function (changeTree, index) {\n//     changeTree.change(0, OPERATION.ADD);\n// };\n// Vec3[$encoder] = function (encoder, bytes, changeTree, index, operation, it) {\n//     encode.number(bytes, changeTree.ref.x, it);\n//     encode.number(bytes, changeTree.ref.y, it);\n//     encode.number(bytes, changeTree.ref.z, it);\n// };\n// Vec3[$decoder] = function (\n//     decoder: Decoder<any>,\n//     bytes: number[],\n//     it: decode.Iterator,\n//     ref: Vec3,\n//     allChanges: DataChange[]\n// ) {\n//     ref.x = decode.number(bytes, it);\n//     ref.y = decode.number(bytes, it);\n//     ref.z = decode.number(bytes, it);\n// };\n\nclass Base extends Schema {}\n\nclass Entity extends Schema {\n    @type(Vec3) position = new Vec3().assign({ x: 0, y: 0, z: 0 });\n}\n\nclass Card extends Schema {\n    @type(\"string\") suit: string;\n    @type(\"number\") num: number;\n}\n\nclass Player extends Entity {\n    @type(Vec3) rotation = new Vec3().assign({ x: 0, y: 0, z: 0 });\n    @type(\"string\") secret: string = \"private info only for this player\";\n\n    @type([Card])\n    cards = new ArraySchema<Card>(\n        new Card().assign({ suit: \"Hearts\", num: 1 }),\n        new Card().assign({ suit: \"Spaces\", num: 2 }),\n        new Card().assign({ suit: \"Diamonds\", num: 3 }),\n    );\n\n    [$callback.$onCreate]() {\n    }\n\n}\n\nclass Team extends Schema {\n    @type({ map: Entity }) entities = new MapSchema<Entity>();\n}\n\nclass State extends Schema {\n    @type(\"number\") num: number = 0;\n    @type(\"string\") str = \"Hello world!\"\n\n    @view() @type([Team]) teams = new ArraySchema<Team>();\n\n    // @type({ map: Entity }) entities = new MapSchema<Entity>();\n\n    // @type(Entity) entity1 = new Player().assign({\n    //     position: new Vec3().assign({ x: 1, y: 2, z: 3 }),\n    //     rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n    // });\n    // @type(Entity) entity2 = new Player().assign({\n    //     position: new Vec3().assign({ x: 1, y: 2, z: 3 }),\n    //     rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n    // });\n}\n\nconst state = new State();\n\n// for (let i=0;i<1000;i++) {\n//     state.entities.set(\"one\" + i, new Player().assign({\n//         position: new Vec3().assign({ x: 1, y: 2, z: 3 }),\n//         rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n//     }));\n// }\n\n// state.entities.set(\"one\", new Player().assign({\n//     position: new Vec3().assign({ x: 1, y: 2, z: 3 }),\n//     rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n// }));\n\n// state.entities.set(\"two\", new Player().assign({\n//     position: new Vec3().assign({ x: 10, y: 10, z: 3 }),\n//     rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n// }));\n\nfunction addTeam() {\n    const team = new Team();\n    team.entities.set(\"one\", new Player().assign({\n        position: new Vec3().assign({ x: 1, y: 2, z: 3 }),\n        rotation: new Vec3().assign({ x: 4, y: 5, z: 6 }),\n    }));\n    team.entities.set(\"two\", new Player().assign({\n        position: new Vec3().assign({ x: 7, y: 8, z: 9 }),\n        rotation: new Vec3().assign({ x: 2, y: 3, z: 4 }),\n    }));\n    state.teams.push(team);\n}\n\naddTeam();\naddTeam();\n\nconst it = { offset: 0 };\n\nconst encoder = new Encoder(state);\n// logTime(\"encode time\", () => encoder.encodeAll());\n\n// const encoded = encoder.encode(it);\n\nconsole.log(\"> will encode all...\", state.toJSON());\nconst encoded = encoder.encode(it);\n\nconsole.log(\"HEAP TOTAL:\", process.memoryUsage().heapTotal / 1024 / 1024, \"MB\");\nconsole.log(\"HEAP USED:\", process.memoryUsage().heapUsed / 1024 / 1024, \"MB\");\n\n// console.log(\"encoded.buffer =>\", `(${encoded.byteLength} bytes)`);\n\nconst sharedOffset = it.offset;\n\n// const team1View = new StateView<State>();\n// team1View.owns(state.teams[0]);\n\nconst view1 = new StateView();\nview1.add(state.teams[0]);\n\n// view1['owned'].add(state[$changes]);\n// view1['owned'].add(state.teams[$changes]);\n// view1.owns(state.teams[0]);\n// view1.owns(state.entities);\n// view1.owns(state.entities.get(\"one\"));\n\nconst view2 = new StateView<State>();\nconsole.log(\">>> VIEW 2\");\nview2.add(state.teams[1]);\n// view2.owns(state.entities.get(\"two\"));\n\nconsole.log(\"> will encode view 1...\");\nconst viewEncoded1 = encoder.encodeView(view1, sharedOffset, it, encoder.sharedBuffer);\nconsole.log(\"done. view1 encoded =>\", `(${viewEncoded1.byteLength} bytes)`);\n\nconsole.log(\"> will encode view 2...\");\nconst viewEncoded2 = encoder.encodeView(view2, sharedOffset, it, encoder.sharedBuffer);\nconsole.log(\"done. view2 encoded =>\", `(${viewEncoded2.byteLength} bytes)`);\n\n// setTimeout(() => {\n//     for (let i = 0; i < 500000; i++) {\n//         encoder.encodeAll();\n//     }\n// }, 1000)\n\n// logTime(\"encode time\", () => encoder.encodeAll());\n\n// console.log(`encode: (${encoded.length})`, encoded);\n\nconsole.log(\"----------------------------------- ENCODE reflection...\");\nconst encodedReflection = Reflection.encode(state, encoder.context);\nconsole.log(\"----------------------------------- DECODE reflection...\");\nconst decodedState = Reflection.decode<State>(encodedReflection);\n\n// const decodedState = new State();\nconst decoder = new Decoder(decodedState);\n\n\n// $(decoder.state).teams.onAdd((team, index) => {\n//     // room.$state.bind(team, frontendTeam);\n//     $(team).entities.onAdd((entity, entityId) => {\n//         $(entity as Player).listen(\"secret\", (value, previousValue) => {\n//         });\n\n//         $(entity).position.onChange(() => {\n//         });\n//     });\n// });\n\nconsole.log(\"> will decode...\");\n// decoder.decode(encoded);\ndecoder.decode(viewEncoded1);\n\nconsole.log(\"Decoded =>\", decoder.state.toJSON());\n\n// decoder.decode(viewEncoded2);\n\n// log(decodedState.toJSON());\n\n// console.log(\"encoder.$root.changes =>\", encoder.$root.changes.length);\n// console.log(\"encoder.$root.filteredChanges =>\", encoder.$root.filteredChanges.length);\n\n// state.teams[0].entities.get(\"one\").position.x = 100;\n\n// // encoder.\n\n// const it2 = { offset: 0 };\n// // const encoded = encoder.encode(it);\n// const encoded2 = encoder.encode(it2);\n// console.log(`> shared encode... (${encoded2.byteLength} bytes)`);\n\n// const viewEncoded3 = encoder.encodeView(view1, sharedOffset, it, encoder.sharedBuffer);\n// console.log(`> view1... (${viewEncoded3.byteLength} bytes)`);\n\n\n// log(decoder.root.toJSON());\n// logTime(\"decode time\", () => decoder.decode(encoded));\n\n// console.log(\"changes =>\", changes);\n\n// const rotation = state.entity.rotation;\n// rotation.x = 100;\n\n// state.entity.rotation = undefined;\n\n// const encoded2 = encoder.encode();\n// console.log({ encoded2 });\n\n// decoder.decode(encoded2);\n// console.log(\"decoded =>\", decoded.toJSON());\n\n// console.profile();\n// const time = Date.now();\n// for (let i = 0; i < 300000; i++) {\n//     const state = new State();\n//     encoder['setRoot'](state);\n//     encoder.encode();\n// }\n// console.log(\"encode time:\", Date.now() - time);\n// console.profileEnd();\n\n// state.players.set(\"entity\", new Entity());\n// state.players.set(\"one\", new Player());\n// console.log(\"state:\", state);\n// console.log(\"state.players\", state.players);\n// console.log(\"state.players.one\", state.players.get(\"one\"));\n// console.log(\"state.players.one.position\", state.players.get(\"one\").position);\n\n// const encoder = new Encoder(state);\n// // encoder.change()\n\n// let encoded = encoder.encodeAll();\n// console.log({ encoded })\n\n// const decoder = new Decoder(new State());\n// decoder.decode(encoded);\n// log(decoder['root'].toJSON());\n\n// const reflection = Reflection.encode(state);\n// console.log(\"encoded =>\", reflection);\n// log(Reflection.decode(reflection))\n\n///////...............................................\n// function type (type: string) {\n//     return function (_: any, context: ClassFieldDecoratorContext) {\n//         context.addInitializer(function() {\n//             console.log(\"INITIALIZER!\", this);\n//             setTimeout(() => {\n//                 context.access.set(this, \"WHAT\");\n//             }, 1000);\n//         });\n\n//         context.access.get = function(object) {\n//             return object[context.name];\n//         }\n\n//         context.access.set = function(object, value) {\n//             console.log(\"setter...\", object, value);\n//             object[context.name] = `Setter[${value}]`;\n//         };\n\n//         return function(value) {\n//             console.log(\"SET\", this, value);\n//             if (typeof(value) === \"string\") {\n//                 value = `Initializer[${value}]`;\n//             } else {\n//                 value = value * 100;\n//             }\n//             return value;\n//         };\n//     }\n// }\n\n// class MyState {\n//     @type(\"string\") name: string = \"Hello world!\";\n//     @type(\"number\") num: number = 1;\n// }\n\n// const state = new MyState();\n// console.log(\"name: \", state.name);\n// console.log(\"num: \", state.num);\n// state.name = `${state.name} modified...`;\n// setTimeout(() => console.log(state.name), 1100);\n"]}